Setting up fedora chroots under debian etch (amd64)
---------------------------------------------------

This file documents what I've done on my debian etch system to set up
i386 and x86_64 chroots in which I can build and test fedora packages
for regina.

These notes are tailored specifically to my own setup, and are not
intended for general use.  See NOTES.txt for further information.


System layout
-------------

- Unless otherwise specified, all work is done under debian etch
  (the "host debian system").

- A standalone fedora installation (the "host fedora system") is
  installed on its own separate partition (currently 4G and 75% full).
  This is mounted within the host debian system in /srv/chroot/fchost.

  The host fedora system is used purely for calling mock to bootstrap
  the various fedora chroots.  At the time of writing it runs fedora 8
  (x86_64) but this may be upgraded from time to time.

- /srv/chroot/fedora is a directory on the host debian system containing
  one subdirectory for each final fedora chroot (the "guest fedora systems").
  This area is mounted from a separate partition (currently 20G, and only
  about 60% full).  Each subdirectory is managed by mock, and the chroot
  filesystems live within root/ inside each of these subdirectories.


Host debian system configuration (debian etch)
----------------------------------------------

- Follow the steps described in 0_init-schroot.txt to set up schroot on
  the host debian system.

- Mount the guest fedora partition as /srv/chroot/fedora, and mount
  the host fedora partition as /srv/chroot/fchost:

  (from /etc/fstab:)
  LABEL=/fedora /srv/chroot/fedora ext3 defaults,errors=remount-ro 0 0
  LABEL=/ /srv/chroot/fchost ext3 defaults,errors=remount-ro 0 0

- Bind-mount the guest fedora partition inside the host fedora partition,
  in the location where mock expects to find it:

  (from /etc/fstab:)
  /srv/chroot/fedora /srv/chroot/fchost/var/lib/mock none rw,bind 0 0

- Add a schroot entry for the fedora host, which will only be used as root:

  [fchost]
  type=directory
  description=Fedora chroot host
  location=/srv/chroot/fchost
  priority=3
  root-users=root
  run-setup-scripts=true
  run-exec-scripts=true


Host fedora system configuration
--------------------------------

- Chroot into the host fedora system and ensure that mock is installed:

  debian# schroot -c fchost yum install mock


Guest fedora system configuration
-----------------------------------


TODO: Everything above is tidied and proofread; everything below is not.


- Enter the fedora host in order to bootstrap the guest system:

  debian# schroot -c fchost

Comment out updates repo in /etc/mock/*.cfg

Set up a base system:

  fchost# mock -r fedora-7-x86_64 --init

Basic graphical system:

  fchost# mock -r fedora-7-x86_64 --install yum man kdelibs kdebase

Note that updates are still enabled in the guest repos.  Check this out.
(both in /etc/yum/yum.conf and /etc/yum.repos.d/fedora-updates.repo)
Also set debuglevel=2 in /etc/yum.conf (at least, if it's currently smaller)

Add schroot entries

- Enter the guest fedora system to continue the installation:

  debian# schroot -c fc7-x86_64

- Rebuild the RPM database in the format expected by the guest system:

  fcguest# rm /var/lib/rpm/__db.*
  fcguest# rpm --rebuilddb

  fcguest# yum repolist (to ensure no updates are selected)

- Install useful utilities:

  fcguest# yum install patchutils rootfiles vim-enhanced wget zsh
                       xdg-utils kde-settings

- Install embedded X servers and some basic fonts:

  fcguest# yum install xorg-x11-server-{Xorg,Xnest,Xephyr}
                       xorg-x11-fonts-{truetype,100dpi,misc,Type1}
                       vnc-server

- Install packages for building and running regina:

  fcguest# yum install rpmlint boost-devel cppunit-devel doxygen
                       gmp-devel kdelibs-devel libselinux-devel
                       libxml2-devel python-devel qt-devel zlib-devel

  fcguest# yum install popt-devel        (on fc8)
  fcguest# yum install popt              (on fc7)
  fcguest# yum install popt libaio-devel (on fc6)

  fcguest# yum install kdeedu graphviz

- Symlink /bin/zsh to /usr/bin/zsh:

  fcguest# ln -s /bin/zsh /usr/bin/zsh

- Manually add an ordinary user:

  fcguest# groupadd -g 1000 bab
  fcguest# useradd -u 1000 -g 1000 bab

- Follow the final steps described in 9_final-guestuser.txt to
  start a chrooted session.

*** TODO: HOW TO DISABLE ccache?
